<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gesti√≥n de Proveedores - Taller Toreto (Admin)</title>

  <link rel="stylesheet" href="../Css/dashboard.css" />
  <style>
    body{margin:0;font-family:Segoe UI, Roboto, Arial, sans-serif;color:#fff;min-height:100vh}
    .bg-video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-1}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:-1}
    .topbar{position:fixed;left:0;right:0;top:0;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.35);z-index:10}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;object-fit:cover}
    main{padding-top:84px;max-width:1200px;margin:0 auto}
    h1{color:var(--accent,#ff6b00);margin:8px 0}
    #proveedoresContainer{padding:12px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .card{background:rgba(255,255,255,0.04);padding:12px;border-radius:10px;position:relative;overflow:hidden;min-height:160px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;transition:transform .2s ease}
    .card:hover{transform:translateY(-4px)}
    .card img{width:100%;height:120px;object-fit:cover;border-radius:8px}
    .card h4{margin:8px 0 0 0;text-align:center;color:#fff}
    .card small{display:block;color:#ddd;margin-top:4px}
    .admin-controls{position:absolute;right:8px;top:8px;display:flex;gap:6px;z-index:20}
    .admin-controls button{background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:6px;padding:4px 6px;cursor:pointer;font-size:14px}
    .admin-controls button:hover{background:rgba(255,255,255,0.15)}
    .btn-primary{background:var(--accent,#ff6b00);border:none;color:#000;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .add-card{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;cursor:pointer;min-height:160px}
    .add-card .plus-sign{font-size:38px}
    .add-card .label{font-weight:700;color:var(--accent,#ff6b00)}

    /* Modal namespaced como en empleados para evitar conflictos */
    .prov-modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:99999;
    }
    .prov-modal{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:#ffffff;color:#000;border-radius:10px;
      padding:20px;max-width:520px;width:94%;
      box-shadow:0 10px 40px rgba(0,0,0,0.45);z-index:100000;
      box-sizing:border-box;
    }
    .prov-modal h3{margin:0 0 10px 0;text-align:center;color:#111;font-size:20px}
    .prov-modal form{display:flex;flex-direction:column;gap:10px;max-height:80vh;overflow-y:auto;padding-right:6px;}
    .prov-modal label{font-weight:600;color:#111;font-size:14px}
    .prov-modal input[type="text"],
    .prov-modal input[type="email"],
    .prov-modal input[type="password"],
    .prov-modal input[type="file"],
    .prov-modal textarea{
      padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px;box-sizing:border-box;
    }
    .prov-modal .small-note{font-size:13px;color:#333;margin-top:-4px}
    .prov-modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:6px}
    .prov-modal .btn-primary{color:#fff;background:var(--accent,#ff6b00);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .prov-modal .btn-secondary{background:#555;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    @media (max-width:480px){.prov-modal{width:96%;padding:14px}}
  </style>
</head>
<body>
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="../images/fondo%20proyecto.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <header class="topbar">
    <div class="brand">
      <img src="../images/logo.webp" alt="logo" class="logo">
      <div><div style="font-weight:700">Taller Toreto</div><div style="font-size:12px;opacity:.8">Panel administrador</div></div>
    </div>
    <div><button id="backBtn" class="btn-primary" title="Volver">Volver</button></div>
  </header>

  <main>
    <h1>Proveedores</h1>
    <div id="proveedoresContainer">
      <div class="cards" id="proveedoresGrid" aria-live="polite"></div>
    </div>
  </main>

  <script>
  /*************************************************************************
   * IndexedDB wrapper (id√©ntico a la soluci√≥n de empleados)
   *************************************************************************/
  (function(){
    window._EmpDB = window._EmpDB || (function(){
      let _db = null;
      function openDB(){
        if(_db) return Promise.resolve(_db);
        return new Promise((res, rej) => {
          if(!('indexedDB' in window)) return rej(new Error('IndexedDB no soportado'));
          const rq = indexedDB.open('TallerToretoDB', 1);
          rq.onupgradeneeded = function(e){
            const db = e.target.result;
            if(!db.objectStoreNames.contains('empleado_files')){
              db.createObjectStore('empleado_files');
            }
          };
          rq.onsuccess = function(){ _db = rq.result; res(_db); };
          rq.onerror = function(ev){ rej(rq.error || new Error('Error abriendo IDB')); };
        });
      }

      function putFile(key, file){
        return openDB().then(db=>{
          return new Promise((res, rej)=>{
            const tx = db.transaction(['empleado_files'], 'readwrite');
            tx.objectStore('empleado_files').put(file, key);
            tx.oncomplete = ()=>res(true);
            tx.onerror = ()=>rej(tx.error || new Error('Error guardando archivo en IDB'));
          });
        });
      }

      function getFile(key){
        return openDB().then(db=>{
          return new Promise((res, rej)=>{
            const tx = db.transaction(['empleado_files'],'readonly');
            const req = tx.objectStore('empleado_files').get(key);
            req.onsuccess = ()=>res(req.result || null);
            req.onerror = ()=>rej(req.error || new Error('Error leyendo archivo en IDB'));
          });
        });
      }

      function deleteFile(key){
        return openDB().then(db=>{
          return new Promise((res, rej)=>{
            const tx = db.transaction(['empleado_files'],'readwrite');
            tx.objectStore('empleado_files').delete(key);
            tx.oncomplete = ()=>res(true);
            tx.onerror = ()=>rej(tx.error || new Error('Error eliminando archivo en IDB'));
          });
        });
      }

      return { openDB, putFile, getFile, deleteFile };
    })();
  })();

  /*************************************************************************
   * L√≥gica de proveedores (metadatos en localStorage 'proveedoresDemo',
   * archivos (foto + cv) en IndexedDB)
   *************************************************************************/
  (function(){
    const grid = document.getElementById('proveedoresGrid');
    const LS_KEY = 'proveedoresDemo';

    function getProveedores(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch(e){ return []; }
    }
    function saveProveedores(list){
      localStorage.setItem(LS_KEY, JSON.stringify(list));
    }
    function generateId(prefix='prov'){
      return `${prefix}_${Date.now()}_${Math.floor(Math.random()*1000000)}`;
    }

    // Renderiza todas las tarjetas
    function cargarProveedores(){
      const lista = getProveedores();
      grid.innerHTML = '';
      lista.forEach((prov, idx) => {
        const card = document.createElement('div'); card.className = 'card';
        const controls = document.createElement('div'); controls.className = 'admin-controls';

        const btnDel = document.createElement('button'); btnDel.type='button'; btnDel.innerText='‚ûñ'; btnDel.title='Eliminar';
        btnDel.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(confirm('¬øEliminar este proveedor?')) eliminarProveedor(idx); });

        const btnEdit = document.createElement('button'); btnEdit.type='button'; btnEdit.innerText='‚úèÔ∏è'; btnEdit.title='Editar';
        btnEdit.addEventListener('click', (ev)=>{ ev.stopPropagation(); abrirModal(prov, idx); });

        const btnPdf = document.createElement('button'); btnPdf.type='button'; btnPdf.innerText='üìã'; btnPdf.title='Descargar documento';
        btnPdf.addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          if(prov.cvKey){
            try{
              const blob = await window._EmpDB.getFile(prov.cvKey);
              if(!blob){ alert('No se encontr√≥ el archivo'); return; }
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a'); a.href = url; a.download = `${sanitizeFileName(prov.empresa||prov.nombre)}_Documento.pdf`;
              document.body.appendChild(a); a.click(); a.remove();
              setTimeout(()=>URL.revokeObjectURL(url), 3000);
            }catch(err){ console.error(err); alert('Error descargando PDF'); }
          } else if(prov.cv){
            // backward-compat: si hay cv en base64 (antiguo), descargar directamente
            const a = document.createElement('a'); a.href = prov.cv; a.download = `${sanitizeFileName(prov.empresa||prov.nombre)}_Documento.pdf`; document.body.appendChild(a); a.click(); a.remove();
          } else {
            alert('No hay documento adjunto para este proveedor.');
          }
        });

        controls.appendChild(btnDel); controls.appendChild(btnEdit); controls.appendChild(btnPdf);
        card.appendChild(controls);

        const img = document.createElement('img'); img.alt = prov.empresa || prov.nombre || 'Proveedor';
        img.src = prov.photoFallback || '../images/repuestos.jpg';
        card.appendChild(img);

        const title = document.createElement('h4'); title.textContent = prov.empresa || prov.nombre || 'Sin nombre';
        card.appendChild(title);
        const contact = document.createElement('small'); contact.textContent = prov.contacto || prov.telefono || prov.email || '';
        card.appendChild(contact);

        grid.appendChild(card);

        // si tiene photoKey, cargar desde IDB
        if(prov.photoKey){
          (async ()=>{
            try{
              const blob = await window._EmpDB.getFile(prov.photoKey);
              if(blob){
                const url = URL.createObjectURL(blob);
                img.src = url;
                setTimeout(()=>URL.revokeObjectURL(url), 60000);
              }
            }catch(e){ console.warn('No se pudo cargar imagen desde IDB', e); }
          })();
        } else if(prov.foto){
          // compatibilidad con formatos previos (base64)
          img.src = prov.foto;
        }
      });

      // tarjeta a√±adir
      const addCard = document.createElement('div'); addCard.className='card add-card';
      addCard.innerHTML = `<div class="plus-sign">‚ûï</div><div class="label">Agregar proveedor</div>`;
      addCard.addEventListener('click', ()=> abrirModal());
      grid.appendChild(addCard);
    }

    async function eliminarProveedor(index){
      const lista = getProveedores();
      const prov = lista[index];
      if(!prov) return;
      // eliminar archivos asociados
      try{
        if(prov.photoKey) await window._EmpDB.deleteFile(prov.photoKey);
        if(prov.cvKey) await window._EmpDB.deleteFile(prov.cvKey);
      }catch(e){ console.warn('Error eliminando archivos en IDB', e); }
      lista.splice(index,1);
      saveProveedores(lista);
      cargarProveedores();
    }

    function sanitizeFileName(name){
      return (name||'file').replace(/[^\w\-_. ]+/g,'').trim().replace(/\s+/g,'_');
    }

    // abrir modal: nuevo o edici√≥n
    async function abrirModal(data=null, index=null){
      // quitar modales previos
      const prev = document.querySelector('.prov-modal-backdrop'); if(prev) prev.remove();

      const backdrop = document.createElement('div'); backdrop.className = 'prov-modal-backdrop';
      const modal = document.createElement('div'); modal.className = 'prov-modal';

      modal.innerHTML = `
        <h3>${data ? 'Editar proveedor' : 'Agregar proveedor'}</h3>
        <form id="provForm" autocomplete="off" novalidate>
          <label for="pNombre">Nombre del contacto</label>
          <input id="pNombre" name="pNombre" type="text" value="${escapeHtml(data?.nombre||'')}" required>

          <label for="pEmpresa">Nombre de la empresa</label>
          <input id="pEmpresa" name="pEmpresa" type="text" value="${escapeHtml(data?.empresa||'')}" required>

          <label for="pTel">Tel√©fono</label>
          <input id="pTel" name="pTel" type="text" maxlength="10" value="${escapeHtml(data?.telefono||'')}" required>
          <div class="small-note">Debe iniciar con 3 y tener 10 d√≠gitos (solo n√∫meros).</div>

          <label for="pMail">Email</label>
          <input id="pMail" name="pMail" type="email" value="${escapeHtml(data?.email||'')}" required>

          <label for="pFoto">Foto (imagen)</label>
          <input id="pFoto" name="pFoto" type="file" accept="image/*" ${data ? '' : 'required'}>

          <label for="pCv">Documento PDF</label>
          <input id="pCv" name="pCv" type="file" accept="application/pdf" ${data ? '' : 'required'}>
          <div class="small-note">${data && (data.photoKey || data.cvKey) ? 'Si no subes archivos nuevos se conservar√°n los existentes.' : ''}</div>

          <label for="pUser">Usuario</label>
          <input id="pUser" name="pUser" type="text" value="${escapeHtml(data?.username||'')}" required>

          <label for="pPass">Contrase√±a</label>
          <input id="pPass" name="pPass" type="password" value="${escapeHtml(data?.password||'')}" required>

          <div class="actions">
            <button type="button" class="btn-secondary" id="btnCancel">Cancelar</button>
            <button type="submit" class="btn-primary" id="btnSave">${data ? 'Guardar' : 'A√±adir'}</button>
          </div>
        </form>
      `;

      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);

      // handlers
      modal.querySelector('#btnCancel').addEventListener('click', ()=> backdrop.remove());

      modal.querySelector('#provForm').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const form = ev.currentTarget;
        const nombre = form.pNombre.value.trim();
        const empresa = form.pEmpresa.value.trim();
        const telefonoRaw = form.pTel.value.trim();
        const telefono = telefonoRaw.replace(/\s+/g,'');
        const email = form.pMail.value.trim();
        const user = form.pUser.value.trim();
        const pass = form.pPass.value;

        // validaciones
        if(!nombre || !empresa || !telefono || !email || !user || !pass){
          alert('Completa todos los campos obligatorios.');
          return;
        }
        if(!/^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(nombre)){
          alert('El nombre del contacto solo puede contener letras y espacios.');
          return;
        }
        if(!/^\d{10}$/.test(telefono) || telefono.charAt(0) !== '3'){
          alert('Tel√©fono inv√°lido. Debe tener 10 d√≠gitos y comenzar con 3.');
          return;
        }
        if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
          alert('Email inv√°lido.');
          return;
        }

        const fotoFile = form.pFoto.files[0];
        const cvFile = form.pCv.files[0];

        // claves actuales (conservar si no se suben nuevas)
        let photoKey = data?.photoKey || null;
        let cvKey = data?.cvKey || null;

        try{
          // Subir foto si se seleccion√≥
          if(fotoFile){
            const newPhotoKey = generateId('prov_photo');
            await window._EmpDB.putFile(newPhotoKey, fotoFile);
            // borrar anterior si exist√≠a
            if(photoKey && photoKey !== newPhotoKey){
              try{ await window._EmpDB.deleteFile(photoKey); }catch(e){ console.warn('Error borrando foto antigua', e); }
            }
            photoKey = newPhotoKey;
          }
          // Subir CV si se seleccion√≥
          if(cvFile){
            if(cvFile.type !== 'application/pdf' && !cvFile.name.toLowerCase().endsWith('.pdf')){
              if(!confirm('El archivo seleccionado no parece un PDF. ¬øDeseas continuar?')) return;
            }
            const newCvKey = generateId('prov_cv');
            await window._EmpDB.putFile(newCvKey, cvFile);
            if(cvKey && cvKey !== newCvKey){
              try{ await window._EmpDB.deleteFile(cvKey); }catch(e){ console.warn('Error borrando cv antiguo', e); }
            }
            cvKey = newCvKey;
          }
        }catch(err){
          console.error('Error guardando archivos en IDB', err);
          alert('Error guardando archivos. Intenta con archivos m√°s peque√±os o recarga la p√°gina.');
          return;
        }

        const lista = getProveedores();
        const provObj = {
          id: data?.id || generateId('prov'),
          nombre,
          empresa,
          telefono,
          email,
          username: user,
          password: pass,
          photoKey: photoKey || null,
          cvKey: cvKey || null
        };

        if(data && typeof index === 'number'){
          lista[index] = provObj;
        } else {
          const dup = lista.find(x => x.username === user);
          if(dup){
            if(!confirm('Ya existe un usuario con ese nombre. ¬øDeseas crear de todas formas?')) return;
          }
          lista.push(provObj);
        }

        try{
          saveProveedores(lista);
        }catch(err){
          console.error('Error guardando metadatos en localStorage', err);
          alert('Error guardando datos (espacio de almacenamiento insuficiente). Intenta reducir el tama√±o de los archivos.');
          return;
        }

        backdrop.remove();
        cargarProveedores();
      });
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, function(ch){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[ch]; });
    }

    // init
    document.getElementById('backBtn').addEventListener('click', ()=>{ location.href='dashboard_admin.html'; });
    cargarProveedores();

    // exponer para debug si quieres
    window.__proveedores_admin = { cargarProveedores };
  })();
  </script>
</body>
</html>




