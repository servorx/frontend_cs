<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gesti√≥n de Proveedores - Taller Toreto (Admin)</title>
  <link rel="stylesheet" href="../Css/dashboard.css" />
  <style>
    body{margin:0;font-family:Segoe UI, Roboto, Arial, sans-serif;color:#fff;min-height:100vh}
    .bg-video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-1}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:-1}
    .topbar{position:fixed;left:0;right:0;top:0;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.35);z-index:10}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;object-fit:cover}
    main{padding-top:84px;max-width:1200px;margin:0 auto}
    h1{color:var(--accent,#ff6b00);margin:8px 0}
    #proveedoresContainer{padding:12px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .card{background:rgba(255,255,255,0.04);padding:12px;border-radius:10px;position:relative;overflow:hidden;min-height:160px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;transition:transform .2s ease}
    .card:hover{transform:translateY(-4px)}
    .card img{width:100%;height:120px;object-fit:cover;border-radius:8px}
    .card h4{margin:8px 0 0 0;text-align:center;color:#fff}
    .card small{display:block;color:#ddd;margin-top:4px}
    .admin-controls{position:absolute;right:8px;top:8px;display:flex;gap:6px;z-index:20}
    .admin-controls button{background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:6px;padding:4px 6px;cursor:pointer;font-size:14px}
    .admin-controls button:hover{background:rgba(255,255,255,0.15)}
    .btn-primary{background:var(--accent,#ff6b00);border:none;color:#000;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .add-card{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;cursor:pointer;min-height:160px}
    .add-card .plus-sign{font-size:38px}
    .add-card .label{font-weight:700;color:var(--accent,#ff6b00)}
    .prov-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:99999;}
    .prov-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;color:#000;border-radius:10px;padding:20px;max-width:520px;width:94%;box-shadow:0 10px 40px rgba(0,0,0,0.45);}
    .prov-modal form{display:flex;flex-direction:column;gap:10px;max-height:80vh;overflow-y:auto;padding-right:6px;}
    .prov-modal label{font-weight:600;color:#111;font-size:14px}
    .prov-modal input,.prov-modal textarea{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px;box-sizing:border-box;}
    .prov-modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:6px}
    .prov-modal .btn-primary{color:#fff;background:var(--accent,#ff6b00);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .prov-modal .btn-secondary{background:#555;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="../images/fondo%20proyecto.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <header class="topbar">
    <div class="brand">
      <img src="../images/logo.webp" alt="logo" class="logo">
      <div>
        <div style="font-weight:700">Taller Toreto</div>
        <div style="font-size:12px;opacity:.8">Panel administrador</div>
      </div>
    </div>
    <div><button id="backBtn" class="btn-primary" title="Volver">Volver</button></div>
  </header>

  <main>
    <h1>Proveedores</h1>
    <div id="proveedoresContainer">
      <div class="cards" id="proveedoresGrid" aria-live="polite"></div>
    </div>
  </main>

  <script>
  (function(){
    window._EmpDB = window._EmpDB || (function(){
      let _db = null;
      function openDB(){
        if(_db) return Promise.resolve(_db);
        return new Promise((res, rej)=>{
          const rq = indexedDB.open('TallerToretoDB', 1);
          rq.onupgradeneeded = e=>{
            const db = e.target.result;
            if(!db.objectStoreNames.contains('empleado_files'))
              db.createObjectStore('empleado_files');
          };
          rq.onsuccess = ()=>{_db = rq.result; res(_db);};
          rq.onerror = ()=>rej(rq.error);
        });
      }
      function putFile(key,file){return openDB().then(db=>new Promise((res,rej)=>{
        const tx=db.transaction(['empleado_files'],'readwrite');
        tx.objectStore('empleado_files').put(file,key);
        tx.oncomplete=()=>res(true);tx.onerror=()=>rej(tx.error);
      }));}
      function getFile(key){return openDB().then(db=>new Promise((res,rej)=>{
        const tx=db.transaction(['empleado_files'],'readonly');
        const req=tx.objectStore('empleado_files').get(key);
        req.onsuccess=()=>res(req.result||null);req.onerror=()=>rej(req.error);
      }));}
      function deleteFile(key){return openDB().then(db=>new Promise((res,rej)=>{
        const tx=db.transaction(['empleado_files'],'readwrite');
        tx.objectStore('empleado_files').delete(key);
        tx.oncomplete=()=>res(true);tx.onerror=()=>rej(tx.error);
      }));}
      return {openDB,putFile,getFile,deleteFile};
    })();
  })();

  (function(){
    const grid=document.getElementById('proveedoresGrid');
    const LS_KEY='proveedoresDemo';
    const get=()=>JSON.parse(localStorage.getItem(LS_KEY)||'[]');
    const save=v=>localStorage.setItem(LS_KEY,JSON.stringify(v));
    const genId=p=>`${p}_${Date.now()}_${Math.floor(Math.random()*1e6)}`;

    function render(){
      const list=get();grid.innerHTML='';
      list.forEach((p,i)=>{
        const card=document.createElement('div');card.className='card';
        const c=document.createElement('div');c.className='admin-controls';
        const del=document.createElement('button');del.textContent='‚ûñ';del.onclick=()=>{if(confirm('¬øEliminar este proveedor?'))remove(i)};
        const edit=document.createElement('button');edit.textContent='‚úèÔ∏è';edit.onclick=()=>openModal(p,i);
        const pdf=document.createElement('button');pdf.textContent='üìã';pdf.onclick=async()=>{
          if(p.cvKey){const blob=await window._EmpDB.getFile(p.cvKey);
            if(!blob)return alert('No se encontr√≥ el archivo');
            const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=p.empresa+'_Documento.pdf';a.click();
            setTimeout(()=>URL.revokeObjectURL(a.href),3000);
          }else alert('No hay documento cargado');
        };
        c.append(del,edit,pdf);card.append(c);
        const img=document.createElement('img');img.src='../images/repuestos.jpg';card.append(img);
        const h4=document.createElement('h4');h4.textContent=p.empresa||p.nombre;card.append(h4);
        const s=document.createElement('small');s.textContent=p.telefono||p.email;card.append(s);
        grid.append(card);
        if(p.photoKey)(async()=>{const b=await window._EmpDB.getFile(p.photoKey);if(b){const u=URL.createObjectURL(b);img.src=u;setTimeout(()=>URL.revokeObjectURL(u),60000);}})();
      });
      const add=document.createElement('div');add.className='card add-card';
      add.innerHTML='<div class="plus-sign">‚ûï</div><div class="label">Agregar proveedor</div>';
      add.onclick=()=>openModal();grid.append(add);
    }

    async function remove(i){
      const list=get();const p=list[i];
      if(p.photoKey)await window._EmpDB.deleteFile(p.photoKey);
      if(p.cvKey)await window._EmpDB.deleteFile(p.cvKey);
      list.splice(i,1);save(list);render();
    }

    function openModal(data=null,index=null){
      document.querySelector('.prov-modal-backdrop')?.remove();
      const b=document.createElement('div');b.className='prov-modal-backdrop';
      const m=document.createElement('div');m.className='prov-modal';
      m.innerHTML=`
        <h3>${data?'Editar proveedor':'Agregar proveedor'}</h3>
        <form id="f">
          <label>Nombre del contacto</label><input id="n" value="${data?.nombre||''}" required>
          <label>Nombre de la empresa</label><input id="em" value="${data?.empresa||''}" required>
          <label>Tel√©fono</label><input id="t" maxlength="10" value="${data?.telefono||''}" required>
          <div class="small-note">Debe iniciar con 3 y tener 10 d√≠gitos.</div>
          <label>Email (usuario)</label><input id="e" type="email" value="${data?.email||''}" required>
          <label>Foto</label><input id="f1" type="file" accept="image/*" ${data?'':'required'}>
          <label>Documento PDF</label><input id="f2" type="file" accept="application/pdf" ${data?'':'required'}>
          <label>Contrase√±a</label><input id="p" type="password" value="${data?.password||''}" required>
          <div class="actions"><button type="button" id="c" class="btn-secondary">Cancelar</button><button class="btn-primary">${data?'Guardar':'A√±adir'}</button></div>
        </form>`;
      b.append(m);document.body.append(b);
      m.querySelector('#c').onclick=()=>b.remove();
      m.querySelector('#f').onsubmit=async ev=>{
        ev.preventDefault();
        const nombre=n.value.trim(),empresa=em.value.trim(),tel=t.value.trim(),email=e.value.trim(),pass=p.value;
        if(!/^\d{10}$/.test(tel)||tel[0]!=='3')return alert('Tel√©fono inv√°lido');
        if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))return alert('Email inv√°lido');
        const foto=f1.files[0],cv=f2.files[0];
        let photoKey=data?.photoKey||null,cvKey=data?.cvKey||null;
        if(foto){const k=genId('prov_photo');await window._EmpDB.putFile(k,foto);if(photoKey&&photoKey!==k)await window._EmpDB.deleteFile(photoKey);photoKey=k;}
        if(cv){const k=genId('prov_cv');await window._EmpDB.putFile(k,cv);if(cvKey&&cvKey!==k)await window._EmpDB.deleteFile(cvKey);cvKey=k;}
        const list=get();
        const prov={id:data?.id||genId('prov'),nombre,empresa,telefono:tel,email,username:email,password:pass,photoKey,cvKey};
        if(index!==null)list[index]=prov;else list.push(prov);
        save(list);b.remove();render();
      };
    }

    document.getElementById('backBtn').onclick=()=>location.href='dashboard_admin.html';
    render();
  })();
  </script>
</body>
</html>




