<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Agenda de trabajo - Taller toreto</title>
<link rel="stylesheet" href="../Css/login.css">
</head>
<body class="with-topbar">
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="../images/fondo%20proyecto.mp4" type="video/mp4">
  </video>
  <header class="topbar"><div class="brand"><img src="../images/logo.webp" class="logo"><span class="brand-name">TallerX</span></div>
    <div class="center-link"><a class="home-link" href="mecanico_dashboard.html">Inicio</a></div>
    <div>
      <span id="sessionBadge" class="session-badge" style="display:none"></span>
    </div>
    <div class="user-area hamburger-menu"><a href="#" class="user-btn" id="userBtn">☰</a>
      <div class="menu" id="userMenu"><a href="mecanico_dashboard.html">Inicio</a><a href="../index.html">Cerrar sesión</a></div>
    </div>
  </header>
  <main>
    <section class="section" style="padding-top:40px">
      <div style="max-width:900px;margin:0 auto;background:rgba(255,255,255,0.03);padding:12px;border-radius:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <button id="prevMonth" class="btn secondary">◀</button>
          <div id="monthLabel" style="font-weight:700;color:var(--accent)"></div>
          <button id="nextMonth" class="btn secondary">▶</button>
        </div>
        <div class="calendar-wrapper"><div id="calendar" style="background:transparent"></div></div>
      </div>
      
      <!-- modal -->
      <div id="modalBackdrop" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true">
          <h3 id="modalTitle">Agregar evento</h3>
          <div class="input-group"><label>Fecha</label><input id="evDate" type="date"></div>
          <div class="input-group"><label>Hora</label><input id="evTime" type="time"></div>
          <div class="input-group"><label>Mecánico</label><input id="evMechanic" type="text"></div>
          <div class="input-group"><label>Cliente</label><input id="evClient" type="text"></div>
          <div class="input-group"><label>Descripción</label><textarea id="evDesc" rows="3"></textarea></div>
          <div class="actions"><button id="cancelEvent" class="btn secondary">Cancelar</button><button id="saveEvent" class="btn">Guardar</button></div>
        </div>
      </div>
    </section>
  </main>
  <script>
  document.addEventListener('DOMContentLoaded', ()=>{
    const cal = document.getElementById('calendar');
    const prev = document.getElementById('prevMonth');
    const next = document.getElementById('nextMonth');
    const label = document.getElementById('monthLabel');
    const modal = document.getElementById('modalBackdrop');
    const saveBtn = document.getElementById('saveEvent');
    const cancelBtn = document.getElementById('cancelEvent');
    const evDate = document.getElementById('evDate');
    const evTime = document.getElementById('evTime');
    const evMechanic = document.getElementById('evMechanic');
    const evClient = document.getElementById('evClient');
    const evDesc = document.getElementById('evDesc');

    let view = new Date();
    let editingId = null;

    function loadEvents(){ return JSON.parse(localStorage.getItem('agenda_events')||'[]'); }
    function saveEvents(arr){ localStorage.setItem('agenda_events', JSON.stringify(arr)); }

    function render(){
      const year = view.getFullYear(); const month = view.getMonth();
      label.textContent = view.toLocaleString('es-ES',{month:'long',year:'numeric'});
      const first = new Date(year,month,1).getDay();
      const daysInMonth = new Date(year,month+1,0).getDate();
    const grid = document.createElement('div'); grid.className='calendar-grid';
    ['Dom','Lun','Mar','Mie','Jue','Vie','Sab'].forEach(d=>{ const h=document.createElement('div'); h.className='weekday'; h.textContent=d; grid.appendChild(h); });
      for(let i=0;i<first;i++) grid.appendChild(document.createElement('div'));
      const events = loadEvents();
      for(let d=1;d<=daysInMonth;d++){
    const cell = document.createElement('div'); cell.className='day-cell';
    const title = document.createElement('div'); title.className='day-number'; title.textContent = d; cell.appendChild(title);
        const dayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayEv = events.filter(e=>e.date===dayStr);
    dayEv.forEach(e=>{ const evDiv=document.createElement('div'); evDiv.className='calendar-event'; evDiv.textContent = `${e.time || ''} ${e.client ? '- '+e.client : ''} ${e.mechanic? ' / '+e.mechanic : ''}`; evDiv.addEventListener('click', ()=>{ openModalFor(dayStr,e.id); }); cell.appendChild(evDiv); });
    const plus = document.createElement('button'); plus.className='calendar-plus'; plus.textContent='➕';
        plus.addEventListener('click', ()=>{ openModalFor(dayStr); });
        cell.appendChild(plus);
        grid.appendChild(cell);
      }
      cal.innerHTML=''; cal.appendChild(grid);
    }

    function openModalFor(date, id){
      editingId = id || null;
      modal.classList.add('show');
      evDate.value = date;
      if(id){ const events = loadEvents(); const ev = events.find(x=>x.id===id); if(ev){ evTime.value = ev.time || ''; evMechanic.value = ev.mechanic || ''; evClient.value = ev.client || ''; evDesc.value = ev.desc || ''; document.getElementById('modalTitle').textContent='Editar evento'; }} else { evTime.value=''; evMechanic.value=''; evClient.value=''; evDesc.value=''; document.getElementById('modalTitle').textContent='Agregar evento'; }
    }

    function closeModal(){ modal.classList.remove('show'); editingId=null; }

    saveBtn.addEventListener('click', ()=>{
      const events = loadEvents();
      if(editingId){ const idx = events.findIndex(x=>x.id===editingId); if(idx>-1){ events[idx].date = evDate.value; events[idx].time = evTime.value; events[idx].mechanic = evMechanic.value; events[idx].client = evClient.value; events[idx].desc = evDesc.value; events[idx].updatedAt = new Date().toISOString(); } }
      else { events.push({ id: 'ev_'+Date.now(), date: evDate.value, time: evTime.value, mechanic: evMechanic.value, client: evClient.value, desc: evDesc.value, createdAt: new Date().toISOString() }); }
      saveEvents(events); closeModal(); render();
    });
    cancelBtn.addEventListener('click', ()=>{ closeModal(); });

    prev.addEventListener('click', ()=>{ view = new Date(view.getFullYear(), view.getMonth()-1, 1); render(); });
    next.addEventListener('click', ()=>{ view = new Date(view.getFullYear(), view.getMonth()+1, 1); render(); });

    render();
  });
  </script>
  <script>
  // ensure main padding equals header height so calendar stays below topbar
  function adjustTopPadding(){
    const header = document.querySelector('.topbar');
    const main = document.querySelector('main');
    if(header && main){ const h = header.getBoundingClientRect().height; main.style.paddingTop = (h + 8) + 'px'; }
  }
  window.addEventListener('load', adjustTopPadding);
  window.addEventListener('resize', adjustTopPadding);
  adjustTopPadding();
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', ()=>{
    const badge = document.getElementById('sessionBadge');
    const logout = document.getElementById('logout');
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    const role = localStorage.getItem('demoRole');
    if(badge){ if(user){ badge.textContent = user.name || 'Usuario'; badge.style.display='inline-block'; } else { badge.style.display='none'; } }
    if(logout) logout.addEventListener('click', ()=>{ localStorage.removeItem('demoRole'); localStorage.removeItem('user'); });
  });
  </script>
  </script>
</body>
</html>