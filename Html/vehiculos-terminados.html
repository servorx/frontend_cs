<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vehículos terminados - TallerX</title>
<link rel="stylesheet" href="../Css/login.css">
<style>
body,html{height:100%;margin:0;font-family:Segoe UI, Roboto, Arial, sans-serif}
.bg-video{position:fixed;inset:0;width:100%;height:100%;z-index:-1;object-fit:cover}
.topbar{position:fixed;left:0;right:0;top:0;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg, rgba(0,0,0,0.35), transparent);backdrop-filter:blur(4px);z-index:1000}
main{padding-top:90px;box-sizing:border-box;padding-bottom:40px}

/* === Tarjetas === */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:20px;
  align-items:start;
  justify-content:center;
  padding:20px;
  box-sizing:border-box;
}
.card{
  background:#f3f3f3;
  color:#111;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,0.25);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  transition:transform .18s;
  height:400px;
}
.card:hover{transform:translateY(-6px)}
.card .imgwrap{height:150px;overflow:hidden;background:#ddd}
.card .imgwrap img{width:100%;height:100%;object-fit:cover;display:block}
.card .body{padding:12px;display:flex;flex-direction:column;flex:1}
.card h3{margin:0 0 8px 0;font-size:18px}
.card .desc{flex:1;overflow:hidden;color:#111;line-height:1.35;margin-bottom:8px;max-height:84px}
.card .meta{color:#666;font-size:14px;margin-bottom:8px;display:flex;justify-content:space-between}
.card .actions{padding:0 12px 12px}
.btn-deliver{
  width:100%;border:none;background:#0a84ff;color:#fff;
  padding:12px;border-radius:10px;font-weight:700;cursor:pointer;
}
.modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1200;
}
.modal{
  background:#fff;color:#000;border-radius:10px;padding:16px;width:92%;max-width:560px;box-shadow:0 12px 36px rgba(0,0,0,0.5);
}
canvas{width:100%;height:260px;border:1px solid #ccc;border-radius:6px;background:#fff}
</style>
</head>
<body>
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="../images/fondo%20proyecto.mp4" type="video/mp4">
  </video>

  <header class="topbar">
    <div class="brand"><img src="../images/logo.webp" class="logo" style="height:44px"><span class="brand-name">TallerX</span></div>
    <div class="center-link"><a class="home-link" href="mecanico_dashboard.html">Inicio</a></div>
    <div><span id="sessionBadge" class="session-badge" style="display:none"></span></div>
    <div class="user-area hamburger-menu"><a href="#" class="user-btn" id="userBtn">☰</a>
      <div class="menu" id="userMenu"><a href="mecanico_dashboard.html">Inicio</a><a href="../index.html">Cerrar sesión</a></div>
    </div>
  </header>

  <main>
    <section class="section">
      <h2 style="color:#0a84ff;margin-left:20px;">Vehículos terminados</h2>
      <div id="list" class="cards" aria-live="polite"></div>
    </section>
  </main>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

  const KEY_FINISHED = 'finished_vehicles';
  const KEY_DELIVERED = 'delivered_vehicles';
  const list = document.getElementById('list');

  let items = [];
  try{ items = JSON.parse(localStorage.getItem(KEY_FINISHED) || '[]'); }catch(e){ items = []; }

  if(items.length === 0){
    list.innerHTML = '<p style="margin:18px;color:#fff">No hay vehículos terminados.</p>';
    return;
  }

  function getDescription(v){
    return v.newDescription || v.workDetails || v.details || v.descripcion || v.problem || v.problems || '';
  }

  items.forEach((v, idx) => {
    const card = document.createElement('article');
    card.className = 'card';

    const imgWrap = document.createElement('div'); imgWrap.className = 'imgwrap';
    const img = document.createElement('img');
    img.alt = 'Foto vehículo';
    img.src = v.photo || '../images/mantenimiento.jpg';
    imgWrap.appendChild(img);

    const body = document.createElement('div'); body.className = 'body';
    const title = document.createElement('h3'); title.textContent = v.title || v.placa || 'Sin placa';

    const descEl = document.createElement('div');
    descEl.className = 'desc';
    descEl.textContent = getDescription(v) || 'Sin descripción';

    // ✅ Mostrar propietario con todas las variantes posibles
    const meta = document.createElement('div'); meta.className = 'meta';
    const ownerName = v.owner || v.propietario || v.nombrePropietario || v.propietarioNombre || v.nombre || '---';
    const phoneNum = v.phone || v.telefono || '---';
    const owner = document.createElement('div'); owner.textContent = `Propietario: ${ownerName}`;
    const phone = document.createElement('div'); phone.textContent = `Tel: ${phoneNum}`;
    meta.appendChild(owner);
    meta.appendChild(phone);

    const actions = document.createElement('div'); actions.className = 'actions';
    const btn = document.createElement('button'); btn.className = 'btn-deliver'; btn.textContent = 'Entregar vehículo';
    btn.dataset.idx = idx;
    actions.appendChild(btn);

    card.appendChild(imgWrap);
    body.appendChild(title);
    body.appendChild(descEl);
    body.appendChild(meta);
    card.appendChild(body);
    card.appendChild(actions);

    list.appendChild(card);
  });

  list.addEventListener('click', (ev)=>{
    if(ev.target.classList.contains('btn-deliver')){
      const idx = Number(ev.target.dataset.idx);
      openSignatureModal(idx);
    }
  });

  function openSignatureModal(idx){
    let itemsNow = JSON.parse(localStorage.getItem(KEY_FINISHED) || '[]');
    const vehicle = itemsNow[idx];
    if(!vehicle) return alert('Vehículo no encontrado.');

    const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop';
    const modal = document.createElement('div'); modal.className = 'modal';
    modal.innerHTML = `
      <h3>Firma de entrega - ${vehicle.title || vehicle.placa || 'Sin placa'}</h3>
      <p>El cliente debe firmar en el recuadro:</p>
      <canvas id="sigCanvas" width="800" height="300"></canvas>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="clearSign" style="padding:8px 12px">Borrar</button>
        <button id="confirmSign" style="padding:8px 12px;background:#0a84ff;color:white;border:none;border-radius:8px;">Entregar</button>
      </div>
    `;
    backdrop.appendChild(modal);
    document.body.appendChild(backdrop);

    const canvas = modal.querySelector('#sigCanvas');
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    let drawing = false;
    function pos(e){
      const r = canvas.getBoundingClientRect();
      if(e.touches && e.touches[0]) e = e.touches[0];
      return {x: e.clientX - r.left, y: e.clientY - r.top};
    }
    function start(e){ drawing = true; const p = pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); }
    function move(e){ if(!drawing) return; const p = pos(e); ctx.lineTo(p.x,p.y); ctx.strokeStyle = '#000'; ctx.lineWidth = 2.5; ctx.lineCap='round'; ctx.stroke(); e.preventDefault(); }
    function stop(){ drawing = false; ctx.closePath(); }
    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', stop);
    canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', stop);

    modal.querySelector('#clearSign').addEventListener('click', ()=>{
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    });

    modal.querySelector('#confirmSign').addEventListener('click', ()=>{
      const dataURL = canvas.toDataURL('image/png');
      const delivered = JSON.parse(localStorage.getItem(KEY_DELIVERED) || '[]');
      vehicle.signature = dataURL;
      vehicle.deliveredAt = new Date().toISOString();
      delivered.push(vehicle);
      localStorage.setItem(KEY_DELIVERED, JSON.stringify(delivered));
      itemsNow.splice(idx,1);
      localStorage.setItem(KEY_FINISHED, JSON.stringify(itemsNow));
      backdrop.remove();
      location.reload();
    });

    backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) backdrop.remove(); });
  }

});
</script>
</body>
</html>






