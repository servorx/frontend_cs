<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Veh√≠culos pendientes - TallerX</title>
<link rel="stylesheet" href="../Css/login.css">
<style>
  /* --- ESPACIADO GLOBAL PARA EVITAR SUPERPOSICI√ìN --- */
  body, html {
    height: 100%;
    overflow-x: hidden;
    overflow-y: auto;
  }

  main {
    padding-top: 130px; /* espacio constante debajo del header */
    margin: 0 auto;
    min-height: calc(100vh - 130px);
    width: 100%;
    box-sizing: border-box;
  }

  .section {
    padding-top: 20px;
    margin-top: 10px;
  }

  /* --- DISTRIBUCI√ìN DE TARJETAS --- */
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
    padding: 20px;
    align-items: start;
    justify-content: center;
  }

  .card {
    background: #f3f3f3;
    color: #111;
    padding: 12px;
    border-radius: 10px;
    text-align: left;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    transition: transform 0.15s ease;
  }

  .card:hover {
    transform: translateY(-2px);
  }

  .card img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 8px;
  }

  .add-card {
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 2px dashed rgba(255, 107, 0, 0.9);
    color: var(--accent);
    font-size: 24px;
    min-height: 200px;
    background: transparent;
  }

  .add-card .label {
    font-weight: 700;
    color: var(--accent);
    margin-top: 6px;
  }

  .admin-controls {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 6px;
    z-index: 20;
  }

  .admin-controls button {
    background: rgba(0, 0, 0, 0.6);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 8px;
    cursor: pointer;
    font-size: 14px;
  }

  .veh-btn {
    background: var(--accent);
    border: none;
    color: #000;
    font-weight: 700;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
  }

  .truncate {
    display: block;
    max-height: 3.6em;
    overflow: hidden;
    position: relative;
  }

  .more-link {
    color: var(--accent);
    cursor: pointer;
    font-weight: 700;
    margin-top: 6px;
    display: inline-block;
  }

  /* --- MODAL DEL FORMULARIO --- */
  .modal-bg {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1100;
  }

  .modal {
    background: #ffffff;
    color: #000;
    padding: 18px;
    border-radius: 10px;
    max-width: 520px;
    width: 94%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45);
    max-height: 90vh;
    overflow: auto;
  }

  .modal h3 {
    text-align: center;
    margin: 0 0 10px 0;
  }

  .modal label {
    font-weight: 600;
    color: #111;
  }

  .modal input[type="text"],
  .modal input[type="number"],
  .modal input[type="file"],
  .modal textarea {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
    color: #000;
    box-sizing: border-box;
  }

  .modal .actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 8px;
  }

  .btn-cancel {
    background: transparent;
    border: 1px solid rgba(0, 0, 0, 0.12);
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
  }
</style>

</head>
<body>
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="../images/fondo%20proyecto.mp4" type="video/mp4">
  </video>

  <header class="topbar">
    <div class="brand"><img src="../images/logo.webp" class="logo"><span class="brand-name">TallerX</span></div>
    <div class="center-link"><a class="home-link" href="mecanico_dashboard.html">Inicio</a></div>
    <div><span id="sessionBadge" class="session-badge" style="display:none"></span></div>
    <div class="user-area hamburger-menu"><a href="#" class="user-btn" id="userBtn">‚ò∞</a>
      <div class="menu" id="userMenu"><a href="mecanico_dashboard.html">Inicio</a><a href="../index.html">Cerrar sesi√≥n</a></div>
    </div>
  </header>

  <main>
    <section class="section">
      <h2>Veh√≠culos pendientes</h2>
      <div id="list" class="cards" aria-live="polite"></div>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', ()=>{

  const KEY_PENDING = 'pending_vehicles';
  const KEY_FINISHED = 'finished_vehicles';
  const listEl = document.getElementById('list');

  let items = JSON.parse(localStorage.getItem(KEY_PENDING) || '[]') || [];

  // Render inicial
  renderList();

  // Mostrar nombre de usuario si existe (objeto user guardado)
  const badge = document.getElementById('sessionBadge');
  try{
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if(badge){
      if(user && (user.name || user.nombre)) badge.textContent = user.name || user.nombre;
      else if(typeof user === 'string') badge.textContent = user;
      badge.style.display = 'inline-block';
    }
  }catch(e){ /* ignore */ }

  // toggle user menu existing functionality (leave intact)
  const userBtn = document.getElementById('userBtn');
  const userMenu = document.getElementById('userMenu');
  if(userBtn) userBtn.addEventListener('click', (e)=>{ e.preventDefault(); userMenu.classList.toggle('show'); });

  // ---------------- renderList ----------------
  function renderList(){
    listEl.innerHTML = '';

    // tarjetas de items
    items.forEach((v, idx)=>{
      const card = document.createElement('div');
      card.className = 'card';
      // controls
      const controls = document.createElement('div');
      controls.className = 'admin-controls';
      controls.innerHTML = `
        <button data-act="del" data-idx="${idx}" title="Eliminar">‚ûñ</button>
        <button data-act="edit" data-idx="${idx}" title="Editar">‚úèÔ∏è</button>
        <button data-act="pdf" data-idx="${idx}" title="Descargar">üìã</button>
      `;
      card.appendChild(controls);

      // image
      const img = document.createElement('img');
      img.src = v.photo || '../images/mantenimiento.jpg';
      img.alt = 'Foto veh√≠culo';
      card.appendChild(img);

      // placa
      const title = document.createElement('h4');
      title.textContent = v.placa || 'Sin placa';
      card.appendChild(title);

      // descripcion con ver mas
      const desc = document.createElement('p');
      desc.className = 'desc-text';
      desc.textContent = v.descripcion || '';
      if((v.descripcion || '').length > 160){
        const truncated = document.createElement('div');
        truncated.className = 'truncate';
        truncated.textContent = v.descripcion;
        const more = document.createElement('span');
        more.className = 'more-link';
        more.textContent = 'Ver m√°s';
        more.addEventListener('click', ()=> toggleMore(truncated, more));
        card.appendChild(truncated);
        card.appendChild(more);
      } else {
        card.appendChild(desc);
      }

      // propietario y telefono en una fila
      const metaRow = document.createElement('div');
      metaRow.className = 'meta-row';
      const owner = document.createElement('small');
      owner.style.color = '#ddd';
      owner.textContent = v.nombre ? `Propietario: ${v.nombre}` : '';
      const phone = document.createElement('small');
      phone.style.color = '#ddd';
      phone.textContent = v.telefono ? `Tel: ${v.telefono}` : '';
      metaRow.appendChild(owner);
      metaRow.appendChild(phone);
      card.appendChild(metaRow);

      // boton Vehiculo terminado
      const btn = document.createElement('button');
      btn.className = 'veh-btn';
      btn.textContent = 'Veh√≠culo terminado';
      btn.dataset.act = 'done';
      btn.dataset.idx = idx;
      card.appendChild(btn);

      listEl.appendChild(card);
    });

    // a√±adir tarjeta ‚ûï al final
    const addCard = document.createElement('div');
    addCard.className = 'card add-card';
    addCard.innerHTML = `<div style="font-size:34px">‚ûï</div><div class="label">Agregar veh√≠culo</div>`;
    addCard.addEventListener('click', ()=> openModal());
    listEl.appendChild(addCard);
  }

  function toggleMore(truncEl, btnEl){
    if(truncEl.style.maxHeight && truncEl.style.maxHeight !== 'none'){
      truncEl.style.maxHeight = 'none';
      btnEl.textContent = 'Ver menos';
    } else {
      truncEl.style.maxHeight = '3.6em';
      btnEl.textContent = 'Ver m√°s';
    }
  }

  // ---------------- modal (crear / editar) ----------------
  function openModal(data=null, index=null){
    // backdrop
    const bg = document.createElement('div');
    bg.className = 'modal-bg';
    bg.id = 'veh-modal-bg';

    // modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <h3>${data ? 'Editar veh√≠culo' : 'Registrar veh√≠culo'}</h3>
      <form id="vehForm" autocomplete="off" novalidate>
        <label for="foto">Foto del veh√≠culo</label>
        <input id="foto" name="foto" type="file" accept="image/*" ${data ? '' : 'required'}>
        <label for="placa">Placa</label>
        <input id="placa" name="placa" type="text" value="${data ? escapeHtml(data.placa||'') : ''}" required>
        <label for="modelo">Modelo</label>
        <input id="modelo" name="modelo" type="text" value="${data ? escapeHtml(data.modelo||'') : ''}" required>
        <label for="anio">A√±o</label>
        <input id="anio" name="anio" type="number" value="${data ? escapeHtml(data.anio||'') : ''}" required>
        <label for="descripcion">Descripci√≥n del problema</label>
        <textarea id="descripcion" name="descripcion" rows="4" required>${data ? escapeHtml(data.descripcion||'') : ''}</textarea>
        <label for="nombre">Nombre del propietario</label>
        <input id="nombre" name="nombre" type="text" value="${data ? escapeHtml(data.nombre||'') : ''}" required>
        <label for="telefono">Tel√©fono</label>
        <input id="telefono" name="telefono" type="text" maxlength="10" value="${data ? escapeHtml(data.telefono||'') : ''}" required>
        <div class="small-note">Tel√©fono debe comenzar con 3 y tener 10 d√≠gitos. Nombre solo letras.</div>

        <div class="actions">
          <button type="button" class="btn-cancel" id="cancelBtn">Cancelar</button>
          <button type="submit" class="veh-btn">${data ? 'Guardar' : 'Crear'}</button>
        </div>
      </form>
    `;
    bg.appendChild(modal);
    document.body.appendChild(bg);

    // handlers
    document.getElementById('cancelBtn').addEventListener('click', ()=> bg.remove());

    const form = modal.querySelector('#vehForm');
    form.addEventListener('submit', function(ev){
      ev.preventDefault();
      // values
      const placa = form.placa.value.trim();
      const modelo = form.modelo.value.trim();
      const anio = form.anio.value.trim();
      const descripcion = form.descripcion.value.trim();
      const nombre = form.nombre.value.trim();
      const telefono = form.telefono.value.trim();

      // validations
      if(!placa || !modelo || !anio || !descripcion || !nombre || !telefono){
        alert('Completa todos los campos.');
        return;
      }
      if(!/^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(nombre)){
        alert('El nombre solo puede contener letras y espacios.');
        return;
      }
      if(!/^\d{10}$/.test(telefono) || telefono.charAt(0) !== '3'){
        alert('Tel√©fono inv√°lido. Debe tener 10 d√≠gitos y comenzar con 3.');
        return;
      }

      const fileInput = form.foto;
      const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

      // If a file is provided read it as dataURL asynchronously, else use existing data.photo if editing
      if(file){
        const reader = new FileReader();
        reader.onload = function(){
          const photoData = reader.result;
          saveVehicleObject({placa,modelo,anio,descripcion,nombre,telefono,photo:photoData});
          bg.remove();
        };
        reader.onerror = function(){
          alert('Error leyendo la imagen. Intenta con otra.');
        };
        reader.readAsDataURL(file);
      } else {
        // keep existing photo if data exists, else undefined
        const photoData = data ? data.photo : null;
        saveVehicleObject({placa,modelo,anio,descripcion,nombre,telefono,photo:photoData});
        bg.remove();
      }

      // save into items (edit or create)
      function saveVehicleObject(obj){
        if(typeof index === 'number' && data){
          items[index] = obj;
        } else {
          items.push(obj);
        }
        try {
          localStorage.setItem(KEY_PENDING, JSON.stringify(items));
        } catch(e) {
          console.error('Error guardando en localStorage', e);
          alert('No se pudo guardar. Intenta eliminar archivos pesados o recarga.');
          return;
        }
        renderList();
      }
    });
  }

  // ---------------- eventos en lista (delegation) ----------------
  listEl.addEventListener('click', async (ev)=>{
    const act = ev.target.dataset.act;
    if(!act) return;

    const idx = Number(ev.target.dataset.idx);
    if(isNaN(idx)) return;

    if(act === 'del'){
      if(confirm('¬øEliminar este veh√≠culo?')){
        items.splice(idx,1);
        localStorage.setItem(KEY_PENDING, JSON.stringify(items));
        renderList();
      }
    } else if(act === 'edit'){
      openModal(items[idx], idx);
    } else if(act === 'pdf'){
      // generar PDF de la ficha del veh√≠culo usando jsPDF
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({unit:'px', format:'a4'});
        const veh = items[idx];
        let y = 20;
        doc.setFontSize(18);
        doc.text(`Ficha veh√≠culo - ${veh.placa || ''}`, 20, y);
        y += 28;
        doc.setFontSize(12);
        doc.text(`Propietario: ${veh.nombre || ''}`, 20, y); y += 18;
        doc.text(`Tel√©fono: ${veh.telefono || ''}`, 20, y); y += 18;
        doc.text(`Modelo: ${veh.modelo || ''}`, 20, y); y += 18;
        doc.text(`A√±o: ${veh.anio || ''}`, 20, y); y += 18;
        doc.text('Descripci√≥n:', 20, y); y += 18;
        // wrap description
        const split = doc.splitTextToSize(veh.descripcion || '', 520);
        doc.text(split, 20, y); y += (split.length * 14) + 10;

        if(veh.photo){
          // add image (scaled)
          try{
            // jsPDF expects image as dataURL with type, we have that
            doc.addImage(veh.photo, 'JPEG', 20, y, 260, 160);
            y += 170;
          }catch(e){
            console.warn('No se pudo agregar la imagen al PDF', e);
          }
        }
        const fileName = `Ficha_${(veh.placa||'vehiculo')}.pdf`;
        doc.save(fileName);
      } catch(err){
        console.error('Error generando PDF', err);
        alert('No se pudo generar PDF. Revisa la consola.');
      }
    } else if(act === 'done'){
      // pedir detalles del trabajo
      const note = prompt('Describa el trabajo realizado:','Reparaci√≥n y mantenimiento realizado');
      if(note === null) return;
      // Llevar a finished
      try{
        const finished = JSON.parse(localStorage.getItem(KEY_FINISHED) || '[]') || [];
        const veh = Object.assign({}, items[idx]);
        veh.trabajo = note;
        // push and save
        finished.push(veh);
        localStorage.setItem(KEY_FINISHED, JSON.stringify(finished));
        // remove from pending
        items.splice(idx,1);
        localStorage.setItem(KEY_PENDING, JSON.stringify(items));
        renderList();
        // opcional: abrir la pagina de terminados? no lo hacemos autom√°ticamente para no romper flujo
      }catch(e){
        console.error('Error moviendo a terminados', e);
        alert('Ocurri√≥ un error al mover el veh√≠culo a terminados.');
      }
    }
  });

  // escapeHtml util
  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, function(ch){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[ch]; });
  }
});
  </script>
</body>
</html>














